name: Docker Image CI for shopify-tracker
on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
        with:
          ref: ${{ github.sha }}
          fetch-depth: 1

      - name: Get image version
        id: get-version
        run: |
          version=$(jq -r .version package.json)
          echo "Version: $version"        
          echo "version=$version" >> $GITHUB_OUTPUT

  build:
    name: Build Shopify Tracker Docker Image
    needs: [extract-version]
    uses: ./.github/workflows/build-and-push-docker-image.yml
    with:
      img_tag: ${{ needs.extract-version.outputs.version }}
      target: production
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  create-pull-request:
    name: Create Pull Request for Shopify Tracker Helm Chart
    runs-on: ubuntu-latest
    needs: [extract-version, build]
    permissions:
      contents: read # GITHUB_TOKEN only needs read for checkout
    env:
      TAG_NAME: ${{ needs.extract-version.outputs.version }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create commits and push changes
          permission-pull-requests: write # to create and update PRs
          repositories: rudder-devops # to access rudder-devops repository

      - name: Clone Devops Repo and Get Base SHA
        id: extract_branch_name
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh repo clone rudderlabs/rudder-devops
          cd rudder-devops
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          BASE_SHA=$(git rev-parse HEAD)
          echo "branch_name=$branch_name"
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT

      - name: Create Branch in Devops Repo via GitHub API
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh api repos/rudderlabs/rudder-devops/git/refs \
            --method POST \
            -f ref="refs/heads/shopify-tracker-$TAG_NAME" \
            -f sha="${{ steps.extract_branch_name.outputs.base_sha }}"

      - name: Update Helm Chart
        env:
          SP_IMAGE_REPOSITORY: rudderstack/rudder-shopify-tracker
        run: |
          cd rudder-devops/helm-charts/helm/shopify-tracking
          yq eval -i ".image.tag=\"$TAG_NAME\"" values.yaml
          yq eval -i ".image.repository=\"$SP_IMAGE_REPOSITORY\"" values.yaml

      - name: Create verified commit via API
        uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        with:
          repository: rudderlabs/rudder-devops
          branch-name: shopify-tracker-${{ env.TAG_NAME }}
          commit-message: 'chore: upgrade shopify tracker to ${{ env.TAG_NAME }}'
          files: |
            helm-charts/helm/shopify-tracking/values.yaml

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd rudder-devops
          gh pr create --fill
